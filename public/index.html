<!DOCTYPE html>
<html>
  <head>
    <meta charset="utf-8" />
    <meta name="viewport" content="width=device-width, initial-scale=1.0" />
    <title>Wo ist Billy?</title>
    <link rel="stylesheet" href="https://unpkg.com/bulma@0.9.2/css/bulma.min.css" />    
  </head>
  <body>
    <div id="app">

<div class="container">
  <h1 class="title">Du suchst ein Komplement? Oder auch mehrere?</h1>


<article class="media">
  <figure class="media-left">
    <p class="image is-64x64">
      <img src="/images/70277957.jpg">
    </p>
  </figure>
  <div class="media-content">
    <div class="content">
      <p>
        Komplement ist ein Brett, genauer gesagt ein Einlegeboden für das PAX-Schranksystem. Mit einer gewissen Sicherheit ist die Größe die du aktuell brauchst bei deinem IKEA gerade nicht verfügbar. Aber vielleicht ja woanders ...
      </p>
    </div>
  </div>
</article>
  
<div v-if="selectedDate" class="notification">
    Du konntest am {{ selectedDate.split("-").reverse().join(".") }} in fünf bestimmten Fillialen <strong>maximal {{ topStockCount }} Komplement-Böden</strong> bekommen. Wie viele findest du?
  </div>

<div class="columns">
  <div class="column">
  <table class="table is-fullwidth is-striped">
    <thead>
      <tr>
        <th>Nr</th>
        <th>Ort</th>
        <th class="has-text-right">Anzahl</th>
      </tr>
    </thead>
    <tbody>
      <tr v-for="(number, index) in maxTries">
        <td>{{ number }}</td>
        <template v-if="selectedStores[index]">
        <td>{{ storeNames[selectedStores[index]] }}</td>
        <td class="has-text-right">{{ stock[selectedStores[index]] }}</td>
        </template>
        <template v-else>
          <td>&nbsp;</td>
          <td>&nbsp;</td>
        </template>
      </tr>
    </tbody>
    <tfoot>
      <tr>
        <th>&nbsp;</th>
        <th>&nbsp;</th>
        <th class="has-text-right">{{ result }}</th>
      </tr>
    </tfoot>
  </table>
  </div>
  <div class="column is-two-thirds">
<div class="buttons">
  <button v-for="store in stores" class="button" :class="{
                                                    'is-outlined': !selectedStores.includes(store.value),
                                                    'is-success': selectedStores.includes(store.value) }" @click="toggle(store.value)" :disabled="maxTries == selectedStores.length">
      {{ store.name }}
  </button>
</div>
    
  </div>
</div>


</div>
    </div>

    <script src="https://unpkg.com/vue@3.0.11/dist/vue.global.prod.js"></script>
    <script src="https://unpkg.com/axios@0.21.1/dist/axios.min.js"></script>

    <script>

      const App = {
  data() {
      return {
          maxTries: 5,
        stores: [],
        selectedStores: [],
        dates: [],
        selectedDate: null,
        stock: {},
          topStockCount: 0,
    }},
    async mounted() {
        const stores = await axios.get("stores.json");
        this.stores = stores.data.filter(store => store["_locale"].country == "de");
        
        const index = await axios.get("index.json");
        this.dates = index.data;
        this.selectedDate = this.dates[this.dates.length-1];

        const stock = await axios.get("data/" + this.selectedDate + ".json");
        this.stock = Object.fromEntries(stock.data.map(item => [item.store_id, item.available_stock]));

        this.topStockCount = Object.values(this.stock).sort((a, b) => b-a).slice(0, 5).reduce((sum, v) => sum + v)
        
    },
    computed: {
        result() {
            return this.selectedStores.map(store => this.stock[store]).reduce((sum, v) => sum + v, 0)
        },
        storeNames() {
            return Object.fromEntries(this.stores.map(store => [store.value, store.name]))
        }
    },
      methods: {
          toggle(storeId) {
              if(this.selectedStores.includes(storeId)) {
                  this.selectedStores = this.selectedStores.filter(store => store != storeId);
              } else {
                  this.selectedStores.push(storeId);
              }
          }
      }
}

Vue.createApp(App).mount('#app')
      

    </script>
  </body>
</html>
